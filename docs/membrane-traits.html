<!DOCTYPE html>  <html> <head>   <title>membrane-traits.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               membrane-traits.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-1">#</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="s1">&#39;use strict&#39;</span>
<span class="kd">var</span> <span class="nx">Trait</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;light-traits&#39;</span><span class="p">).</span><span class="nx">Trait</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-2">#</a>               </div>               <h1>MembraneTrait</h1>

<p>Trait can be used in a trait composition to defines lazy property <code>membrane</code>.
<code>MembraneTrait</code> is also a function and can be used directly to create trait
compositions using exactly the same API as with Trait function.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">MembraneTrait</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-3">#</a>               </div>               <p>New instance of <code>MembraneTrait</code> is used to hold all the property
descriptors.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">TMembrane</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">MembraneTrait</span><span class="p">.</span><span class="nx">prototype</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-4">#</a>               </div>               <p>Trait composition is created passing all the arguments to original <code>Trait</code>
function. <code>Trait</code> function is called once again with a returned and
<code>MembraneTrait</code> traits to compose final trait.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="p">,</span>   <span class="nx">trait</span> <span class="o">=</span> <span class="nx">Trait</span><span class="p">(</span><span class="nx">Trait</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">),</span> <span class="nx">MembraneTrait</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-5">#</a>               </div>               <p>All the property descriptors are copied from trait to the <code>MembraneTrait</code>
instance in order to provide special behavior of <code>create</code> method of
returned trait.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">trait</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">TMembrane</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">trait</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
  <span class="p">})</span>
  <span class="k">return</span> <span class="nx">TMembrane</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-6">#</a>               </div>               <h2>Examples:</h2>

<pre><code> // Using as trait constructor.
 var MembraneTrait = require('membrane-traits').MembraneTrait
 var TGreeting = MembraneTrait(
 { _greeting: 'Hello '
 , name: MembraneTrait.required
 , greet: function greet(name) {
     return this._greeting + name
   }
 })

 var g = TGreeting.create({ name: 'membrane', lastName: 'trait' })
 '_greeting' in g    // false &lt;- privates are not exposed
 'lastName' in g     // false &lt;- only trait properties are exposed
 g.name              // "membrane"
 g.greet('consumer') // "Hello Consumer"

 // Using as a trait in composition.
 var Trait = require('light-traits').Trait
 ,   MembraneTrait = require('membrane-traits').MembraneTrait

 var TGreeting1 = Trait(
 { _greeting: 'Hello '
 , name: MembraneTrait.required
 }
 var TGreeting2 = Trait(
 { greet: function greet(name) {
     return this._greeting + name
   }
 })
 var TMGreeting = Trait
 ( MembraneTrait
 , TGreeting1
 , TGreeting2
 )

 var g = TMGreeting.create({ name: 'membrane', lastName: 'trait' })
 g._greeting           // "Hello "
 g.membrane._greeting  // undefined
</code></pre>

<h1>MembraneTrait.required</h1>

<p>Property is just an alias of the <code>Trait.required</code> that is handy when using
<code>MembraneTrait</code> as a trait constructor in a modules that don't directly
depend on <code>Trait</code> itself.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">MembraneTrait</span><span class="p">.</span><span class="nx">required</span> <span class="o">=</span> <span class="nx">Trait</span><span class="p">.</span><span class="nx">required</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-7">#</a>               </div>               <h1>MembraneTrait.membrane</h1>

<p>This is a property exposed by <code>MembraneTrait</code>. Property represents
membrane / facade of an object that contains it. Membrane exposes all the
public properties and methods of an object that were defined in the trait
used to instantiate object. All the properties whose name don't with <code>_</code> are
considered to be public.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">MembraneTrait</span><span class="p">.</span><span class="nx">membrane</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">membrane</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-8">#</a>               </div>               <p>Creating instance of <code>Membrane</code> to make it explicit for it's consumers that
they deal with a membrane and not an actual object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">membrane</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Membrane</span><span class="p">()</span>
  <span class="p">,</span>   <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyNames</span><span class="p">(</span><span class="k">this</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-9">#</a>               </div>               <p>Enumerating all the own properties of an object. Those are all the
properties defined by a trait that is used to instantiate this object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ii</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">ii</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">key</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-10">#</a>               </div>               <p>Skipping this and the privates properties.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;membrane&#39;</span> <span class="o">===</span> <span class="nx">key</span> <span class="o">||</span> <span class="s1">&#39;_&#39;</span> <span class="o">===</span> <span class="nx">key</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="k">continue</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-11">#</a>               </div>               <p>Defining membranes / proxy accessors for all other properties.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">membrane</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">PropertyMembrane</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-12">#</a>               </div>               <p>Redefining this getter as static property, in order to return same
membrane for every access of this property.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;membrane&#39;</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">membrane</span>
  <span class="p">,</span> <span class="nx">configurable</span><span class="o">:</span> <span class="kc">false</span>
  <span class="p">})</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">membrane</span>
<span class="p">},</span> <span class="nx">configurable</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-13">#</a>               </div>               <h1>create</h1>

<p>Instances of the <code>MembraneTrait</code> (traits that are created by invoking that
function) inherit special <code>create</code> function that is different form regular
trait's create function in a way that returned objects are membranes rather
then an actual instances.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">MembraneTrait</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">Trait</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span>
<span class="p">{</span> <span class="nx">create</span><span class="o">:</span> <span class="p">{</span> <span class="nx">value</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">create</span><span class="p">(</span><span class="nx">proto</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Trait</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">create</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">proto</span><span class="p">).</span><span class="nx">membrane</span>
  <span class="p">}}</span>
<span class="p">}))</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">MembraneTrait</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">(</span><span class="nx">MembraneTrait</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-14">#</a>               </div>               <h3>Membrane</h3>

<p>Internal function that is used as a base class for all instances created by
calling <code>create</code> method on an instance of <code>MembraneTrait</code>. <br />
For details see <code>PropertyMembrane</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Membrane</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">(</span><span class="kd">function</span> <span class="nx">Membrane</span><span class="p">()</span> <span class="p">{})</span>
<span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">(</span><span class="nx">Membrane</span><span class="p">.</span><span class="nx">prototype</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-15">#</a>               </div>               <h3>Getter</h3>

<p>Internal function that is used to generate getters for properties wrapped
with in membrane. <br />
For details see <code>PropertyMembrane</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Getter</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">(</span><span class="kd">function</span> <span class="nx">membraneGetter</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
<span class="p">})</span>
<span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">(</span><span class="nx">Getter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-16">#</a>               </div>               <h3>Setter</h3>

<p>Internal function that is used to generate setters for properties wrapped
with in membrane. <br />
For details see <code>PropertyMembrane</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Setter</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">(</span><span class="kd">function</span> <span class="nx">membraneSetter</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span> 
  <span class="k">this</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
<span class="p">})</span>
<span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">(</span><span class="nx">Setter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-17">#</a>               </div>               <h3>Method</h3>

<p>Internal factory function that is used to generate method membranes.
Function takes <code>target</code> object wrapped by a membrane and method <code>name</code> as
arguments and returns a function that proxies to a wrapped one once it's
called.
For details see <code>PropertyMembrane</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Method</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">(</span><span class="kd">function</span> <span class="nx">Method</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span> 
  <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">(</span><span class="kd">function</span> <span class="nx">membraneMethod</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-18">#</a>               </div>               <p>If value of pseudo-variable <code>this</code> matches the <code>membrane</code> property
of wrapped object then <code>this</code> should be a wrapped object itself, if not
then method was invoked with <code>apply</code> or <code>call</code> and <code>this</code> pseudo variable
is just passed through.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">target</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">membrane</span> <span class="o">!=</span> <span class="k">this</span> <span class="o">?</span> <span class="k">this</span> <span class="o">:</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">})</span>
<span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">(</span><span class="nx">Method</span><span class="p">.</span><span class="nx">prototype</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-19">#</a>               </div>               <h3>PropertyMembrane</h3>

<p>Internal function that is used to generate property membranes. Function
takes <code>target</code> object that is wrapped by a membrane and <code>name</code> of the
property and generates property descriptor for it.
For details see <code>PropertyMembrane</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">PropertyMembrane</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-20">#</a>               </div>               <p>Getting property descriptor for the property.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">property</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyDescriptor</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
  <span class="p">,</span>   <span class="nx">descriptor</span> <span class="o">=</span>
      <span class="p">{</span> <span class="nx">configurable</span><span class="o">:</span> <span class="nx">property</span><span class="p">.</span><span class="nx">configurable</span>
      <span class="p">,</span> <span class="nx">enumerable</span><span class="o">:</span> <span class="nx">property</span><span class="p">.</span><span class="nx">enumerable</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-21">#</a>               </div>               <p>If original property has a getter using it's target bounded copy.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">property</span><span class="p">.</span><span class="nx">get</span><span class="p">)</span> <span class="nx">descriptor</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="nx">property</span><span class="p">.</span><span class="nx">get</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-22">#</a>               </div>               <p>If original property has a setter using it's target bounded copy.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">property</span><span class="p">.</span><span class="nx">set</span><span class="p">)</span> <span class="nx">descriptor</span><span class="p">.</span><span class="nx">set</span> <span class="o">=</span> <span class="nx">property</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;value&#39;</span> <span class="k">in</span> <span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">property</span><span class="p">.</span><span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-23">#</a>               </div>               <p>If original property is a method generating membrane for it.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">descriptor</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">Method</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
      <span class="nx">descriptor</span><span class="p">.</span><span class="nx">writable</span> <span class="o">=</span> <span class="nx">property</span><span class="p">.</span><span class="nx">writable</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-24">#</a>               </div>               <p>If it's just a property generating accessors to it.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">descriptor</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="nx">Getter</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
      <span class="nx">descriptor</span><span class="p">.</span><span class="nx">set</span> <span class="o">=</span> <span class="nx">Setter</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">descriptor</span>
<span class="p">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 